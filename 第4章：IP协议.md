### 4.1 IP 即网际协议

#### 1. IP 相当于 OSI 参考模型的第 3 层

网络层的主要作用是实现终端节点之间的通信。这种终端节点之间的通信也叫点对点通信。

从前面的章节可知，网络层的下一层，**`数据链路层的主要作用在互联同一种数据链路的节点之间进行包传递`** 。而一旦跨越多种数据链路，就需要借助网络层。网络层可以 **`跨越不同的数据链路`** ，即使在不同的数据链路中也能实现两端节点之间的数据包传输。

* **`主机与节点`**

  在互联网世界中，将那些配有 **`IP 地址的设备叫做主机`** 。这里的主机，可以是超大型计算机，也可以是小型计算机。这是因为互联网在当初刚发明的时候，只能连接这类大型的设备，因此习惯上就将配有 IP 地址的设备称为主机。

  然而，准确的说，**`主机的定义应该是指配置有 IP 地址，但是不进行路由控制的设备`** 。**`既配有 IP 地址又具有路由控制能力的设备叫做路由器`** ，跟主机有所区别。而 **`节点则是主机和路由器的统称`** 。



### 4.2 IP 基础知识

#### 1. IP 地址属于网络层地址

IP 地址用于在 **`连接到网络中的所有主机中识别出进行通信的目标地址`** 。因此，在 TCP/IP 通信中所有 **`主机或路由器`** 必须设定自己的 IP 地址。

不论一台主机与哪种数据链路连接，其 IP 地址的形式都保持不变。以太网、无线局域网、PPP 等，都不会改变 IP 地址的形式。

另外，在 **`网桥或交换集线器`** 等物理层或数据链路层数据包转发设备中，不需要设置 IP 地址。因为这些设备只负责将 IP 包转化为 0、1 比特流转发或对数据链路帧的数据部分进行转发，而不需要应对 IP 协议。



#### 2. 路由控制

* **`发送数据至最终目标地址`** 

​	跳，它是指 **`网络中的一个区间`** 。IP包正是在网络中一个个跳间被转发。因此 IP 路由也叫做 **`多跳路由`** 。在每一个区间内决定着包在 **`下一跳被转发的路径`** 。

* **`一跳的范围`**

  一跳是指利用  **`数据链路层以下分层的功能传输数据帧的一个区间`** 。以太网等数据链路中使用 MAC 地址传输数据帧。此时的一跳是指从源 MAC 地址到目标 MAC 地址之间传输帧的区间。也就是说它是主机或路由器网卡不经其他路由器而能直接到达的相邻主机或路由器网卡之间的一个区间。在一跳的这个区间内，电缆可以通过网桥或交换集线器相连，不会通过路由器或网关相连。

* **`多跳路由`**

  多跳路由是指  **`路由器或主机在转发 IP 数据包时只指定下一个路由器或主机`** ，而不是将到最终目标地址为止的所有通路全都指定出来。因为每一个区间（跳）在转发 IP 数据包时会分别指定  **`下一跳的操作`** ，直至包达到最终的目标地址。              

* **`路由控制表`**

  为了将数据包发给目标主机，**`所有主机都维护着一张路由控制表`** 。该表记录 **`IP 数据在下一步应该发给哪个路由器`** 。IP 包将根据这个路由表在各个数据链路上传输。



#### 3. 数据链路的抽象化

不同数据链路有个最大的区别，就是它们各自的 **`最大传输单位（MTU）`** 不同。就好像人们在邮寄包裹或行李时有各自的大小限制一样。

MTU 的值在 **`以太网中是 1500 字节，在 FDDI 中是 4352 字节，而 ATM 则为 9180 字节`** 。IP 的上一层可能会要求传送比这些 MTU 更多字节的数据，因此必须在线路上传送比包长还要小的 MTU。为了解决这个问题， **`IP 进行分片处理`** 。顾名思义，所谓分片处理是指， **`将较大的 IP 包分成多个较小的 IP 包`** 。分片的包   **`到了对端目标地址以后再被组合起来传给上一层`** 。即从 IP 的上层看，它完全可以忽略数据包在途中的各个数据链路上的 MTU，而只需要按照源地址发送的长度接收数据包。IP 就是以这种方式抽象化了数据链路层，使得从上层更不容易看到底层网络构造的细节。



#### 4. IP 属于面向无连接型

1. **`简化`**
2. **`提速`**

* 为了提高可靠性，上一层的 TCP  采用面向有连接型



### 4.3 IP 地址的基础知识

#### 1. IP 地址的定义

IP 地址（IPv4 地址）由 **`32 位正整数`** 来表示。TCP/IP 通信要求将这样的 IP 地址分配给每一个参与通信的主机。IP 地址在计算机内部以二进制方式被处理。然而，由于人类社会并不习惯于采用二进制方式，需要采用一种特殊的标记方式。那就是将 32 位的 IP 地址以 **`每 8 位为一组，分成 4 组，每组以 "." 隔开`** ，再将 **`每组数转换为十进制数`** 。下面举例说明这一方法。                                                                                          

10101100             00010100           00000001        00000001       （2 进制） 

10101100             00010100           00000001        00000001       （2 进制）

172                        20                         1                       1                      （10 进制） 



将表示成 IP 地址的数字整体计算，会得出如下数值。

2^32 = 4 294 967 296

从这个计算结果可知，最多可以允许 **`43 亿台计算机`** 连接到网络。

实际上，IP 地址并非是根据 **`主机台数`** 来配置的，而是 **`每一台主机上的每一块网卡（NIC）都得设置 IP 地址`** 。 通常一块网卡只设置一个 IP 地址，其实每一块网卡也可以设置多个 IP 地址 。 此外，一台路由器通常都会配置两个以上的网卡，因此可以设置两个以上的 IP 地址 。因此，让 43 亿台计算机全部连网其实是不可能的。后面将要详细介绍 IP 地址的两个组成部分 **`（网络标识和主机标识）`** ，了解了这两个组成部分后你会发现实际能够连接到网络的计算机个数更是少了很多。



#### 2. IP 地址由网络和主机两部分标识组成

IP 地址由网络地址和主机地址两部分组成。

网络标识在数据链路的每个段配置不同的值。网络标识必须保证相互连接的 **`每个段的地址不相重复`** 。而相同段内相连的主机必须有相同的网络地址。IP 地址的主机标识则 **`不允许在同一个网段内重复出现`** 。由此，可以通过设置网络地址和主机地址，在相互连接的整个网络中保证每台主机的 IP 地址都不会相互重叠。即 IP 地址具有了唯一性。

IP 包被转发到途中某个路由器时，正是利用目标 IP 地址的网络标识进行路由。因为即使不看主机标识，只要一见到网络标识就能判断出是否为该网段内的主机。那么，究竟是从第几位开始到第几位算是网路标识，又从第几位开始到第几位算是主机标识？关于这点，有约定俗成的两种类型。最初二者以分类进行区别。而现在基本以 **`子网掩码（网络前缀）区分`** 。不过，请读者注意，在有些情况下依据部分功能、系统和协议的需求，前一种的方法依然存在。

**`192.168.128.10/24`** 中的 "/24" 表示从第 1 位开始到多少位属于网络标识。在这个例子中，192.168.128 之前的都是该 IP 的网络地址。



#### 3. IP 地址的分类

* **`A 类地址`**

  A 类 IP 地址是首位以 "0" 开头的地址。从第 1 位到第 8 位是它的网络标识。用十进制表示的话，0.0.0.0 ~ 127.0.0.0 是 A 类的网络地址。A 类的地址的后 24 位相当于主机标识。因此，一个网段内可容纳的主机地址上限为 16777214 个。

* **`B 类地址`**

  B 类 IP 地址是前两位为 "10" 的地址。从第 1 位到第 16 位是它的网络标识。用十进制表示的话，128.0.0.1 ~ 191.255.0.0 是 B 类的网络地址。B 类地址的后 16 位相当于主机标识。因此，一个网段内可容纳的主机地址上限为 65534 个。

* **`C 类地址`**

  C 类 IP 地址是前三位为 "110" 的地址。从第 1 位到第 24 位是它的网络标识。用十进制表示的话，192.0.0.0 ~ 223.255.255.0 是 C 类的网络地址。C 类地址的后 8 位相当于主机标识。因此，一个网段内可容纳的主机地址上限为 254 个。

* **`D 类地址`**

​	D 类 IP 地址是前四位为 "1110" 的地址。从第 1 位到第 32 位是它的网络标识。用十进制表示的话，224.0.0.0 ~ 239.255.255.255 的是 D 类的网络地址。D 类地址没有主机标识，常被用于多播。

* **`关于分配 IP 主机地址的注意事项`**

  在分配 IP 地址时关于主机标识有一点需要注意。即要用比特位表示主机地址时，不可以全部为 0 或全部为 1。因为全部为只有 0 在表示对应的网络地址或 IP 地址 **`不可获知的情况下才使用`** 。而全部为 1 的主机地址通常作为 **`广播地址`** 。



#### 4. 广播地址

广播地址用于在 **`同一个链接中相互连接的主机之间发送数据包`** 。将 IP 地址中的 **`主机地址部分全部设置为 1`** ，就改成了广播地址。例如把 172.20.0.0/16 用二进制表示如下：

10101100.00010100.00000000.00000000      （二进制）

将这个地址的主机部分全部改为 1，则形成广播地址：

10101100.00010100.11111111.11111111      （二进制）

再将这个地址用十进制表示，则为 172.20.255.255。



* 两种广播

​	广播分为 **`本地广播`** 和 **`直接广播`** 两种。

​	**`在本网络内的广播`** 叫做本地广播。例如网络地址为 192.168.0.0/24 的情况下，广播地址是 192.168.0.255。因为这个广播地址的 IP 包会被路由器屏蔽掉，所以不会到达 192.168.0.0/24 以外的其他链路上。

​	**`在不同网络之间的广播`** 叫做直接广播。例如网络地址为 192.168.0.0/24 的主机向 192.168.1.255/24 的目标地址发送 IP 包。收到这个包的路由器，将数据转发给 192.168.1.0/24，从而使得所有 192.168.1.1 ~ 192.168.1.254 的主机都能收到这个包。



#### 5. IP 多播

* **`同时发送提交效率`**

多播用于将包发送给特定组内的所有主机。由于其直接使用 IP 协议，因此也不存在可靠传输。







​       